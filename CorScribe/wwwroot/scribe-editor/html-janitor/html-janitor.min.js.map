{"version":3,"file":"html-janitor.min.js","mappings":"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","sources":["../src/html-janitor.js"],"sourcesContent":["(function (root, factory) {\n  if (typeof define === 'function' && define.amd) {\n    define('html-janitor', factory);\n  } else if (typeof exports === 'object') {\n    module.exports = factory();\n  } else {\n    root.HTMLJanitor = factory();\n  }\n}(this, function () {\n\n  /**\n   * @param {Object} config.tags Dictionary of allowed tags.\n   * @param {boolean} config.keepNestedBlockElements Default false.\n   */\n  function HTMLJanitor(config) {\n\n    var tagDefinitions = config['tags'];\n    var tags = Object.keys(tagDefinitions);\n\n    var validConfigValues = tags\n      .map(function(k) { return typeof tagDefinitions[k]; })\n      .every(function(type) { return type === 'object' || type === 'boolean' || type === 'function'; });\n\n    if(!validConfigValues) {\n      throw new Error(\"The configuration was invalid\");\n    }\n\n    this.config = config;\n  }\n\n  // TODO: not exhaustive?\n  var blockElementNames = ['P', 'LI', 'TD', 'TH', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'PRE'];\n  function isBlockElement(node) {\n    return blockElementNames.indexOf(node.nodeName) !== -1;\n  }\n\n  var inlineElementNames = ['A', 'B', 'STRONG', 'I', 'EM', 'SUB', 'SUP', 'U', 'STRIKE'];\n  function isInlineElement(node) {\n    return inlineElementNames.indexOf(node.nodeName) !== -1;\n  }\n\n  HTMLJanitor.prototype.clean = function (html) {\n    var sandbox = document.createElement('div');\n    sandbox.innerHTML = html;\n\n    this._sanitize(sandbox);\n\n    return sandbox.innerHTML;\n  };\n\n  HTMLJanitor.prototype._sanitize = function (parentNode) {\n    var treeWalker = createTreeWalker(parentNode);\n    var node = treeWalker.firstChild();\n    if (!node) { return; }\n\n    do {\n      // Ignore nodes that have already been sanitized\n      if (node._sanitized) {\n        continue;\n      }\n\n      if (node.nodeType === Node.TEXT_NODE) {\n        // If this text node is just whitespace and the previous or next element\n        // sibling is a block element, remove it\n        // N.B.: This heuristic could change. Very specific to a bug with\n        // `contenteditable` in Firefox: http://jsbin.com/EyuKase/1/edit?js,output\n        // FIXME: make this an option?\n        if (node.data.trim() === ''\n            && ((node.previousElementSibling && isBlockElement(node.previousElementSibling))\n                 || (node.nextElementSibling && isBlockElement(node.nextElementSibling)))) {\n          parentNode.removeChild(node);\n          this._sanitize(parentNode);\n          break;\n        } else {\n          continue;\n        }\n      }\n\n      // Remove all comments\n      if (node.nodeType === Node.COMMENT_NODE) {\n        parentNode.removeChild(node);\n        this._sanitize(parentNode);\n        break;\n      }\n\n      var isInline = isInlineElement(node);\n      var containsBlockElement;\n      if (isInline) {\n        containsBlockElement = Array.prototype.some.call(node.childNodes, isBlockElement);\n      }\n\n      // Block elements should not be nested (e.g. <li><p>...); if\n      // they are, we want to unwrap the inner block element.\n      var isNotTopContainer = !! parentNode.parentNode;\n      var isNestedBlockElement =\n            isBlockElement(parentNode) &&\n            isBlockElement(node) &&\n            isNotTopContainer;\n\n      var nodeName = node.nodeName.toLowerCase();\n\n      var allowedAttrs = getAllowedAttrs(this.config, nodeName, node);\n\n      var isInvalid = isInline && containsBlockElement;\n\n      // Drop tag entirely according to the whitelist *and* if the markup\n      // is invalid.\n      if (isInvalid || shouldRejectNode(node, allowedAttrs)\n          || (!this.config.keepNestedBlockElements && isNestedBlockElement)) {\n        // Do not keep the inner text of SCRIPT/STYLE elements.\n        if (! (node.nodeName === 'SCRIPT' || node.nodeName === 'STYLE')) {\n          while (node.childNodes.length > 0) {\n            parentNode.insertBefore(node.childNodes[0], node);\n          }\n        }\n        parentNode.removeChild(node);\n\n        this._sanitize(parentNode);\n        break;\n      }\n\n      // Sanitize attributes\n      for (var a = 0; a < node.attributes.length; a += 1) {\n        var attr = node.attributes[a];\n\n        if (shouldRejectAttr(attr, allowedAttrs, node)) {\n          node.removeAttribute(attr.name);\n          // Shift the array to continue looping.\n          a = a - 1;\n        }\n      }\n\n      // Sanitize children\n      this._sanitize(node);\n\n      // Mark node as sanitized so it's ignored in future runs\n      node._sanitized = true;\n    } while ((node = treeWalker.nextSibling()));\n  };\n\n  function createTreeWalker(node) {\n    return document.createTreeWalker(node,\n                                     NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_COMMENT,\n                                     null, false);\n  }\n\n  function getAllowedAttrs(config, nodeName, node){\n    if (typeof config.tags[nodeName] === 'function') {\n      return config.tags[nodeName](node);\n    } else {\n      return config.tags[nodeName];\n    }\n  }\n\n  function shouldRejectNode(node, allowedAttrs){\n    if (typeof allowedAttrs === 'undefined') {\n      return true;\n    } else if (typeof allowedAttrs === 'boolean') {\n      return !allowedAttrs;\n    }\n\n    return false;\n  }\n\n  function shouldRejectAttr(attr, allowedAttrs, node){\n    var attrName = attr.name.toLowerCase();\n\n    if (allowedAttrs === true){\n      return false;\n    } else if (typeof allowedAttrs[attrName] === 'function'){\n      return !allowedAttrs[attrName](attr.value, node);\n    } else if (typeof allowedAttrs[attrName] === 'undefined'){\n      return true;\n    } else if (allowedAttrs[attrName] === false) {\n      return true;\n    } else if (typeof allowedAttrs[attrName] === 'string') {\n      return (allowedAttrs[attrName] !== attr.value);\n    }\n\n    return false;\n  }\n\n  return HTMLJanitor;\n\n}));\n\n"],"names":["root","factory","define","amd","exports","module","HTMLJanitor","this","config","tagDefinitions","tags","Object","keys","validConfigValues","map","k","every","type","Error","isBlockElement","node","blockElementNames","indexOf","nodeName","isInlineElement","inlineElementNames","createTreeWalker","document","NodeFilter","SHOW_TEXT","SHOW_ELEMENT","SHOW_COMMENT","getAllowedAttrs","shouldRejectNode","allowedAttrs","shouldRejectAttr","attr","attrName","name","toLowerCase","value","prototype","clean","html","sandbox","createElement","innerHTML","_sanitize","parentNode","treeWalker","firstChild","_sanitized","nodeType","Node","TEXT_NODE","COMMENT_NODE","removeChild","containsBlockElement","isInline","Array","some","call","childNodes","isNotTopContainer","isNestedBlockElement","isInvalid","keepNestedBlockElements","length","insertBefore","a","attributes","removeAttribute","data","trim","previousElementSibling","nextElementSibling","nextSibling"]}